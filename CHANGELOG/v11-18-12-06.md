# v11-18-12:06 패치 노트

## 주요 변경사항

### 1. 디플레이션(Deflation) 타이밍 수정 ⚠️
**문제**: 선택 단계에서 +10 에테르로 표시되던 것이 진행 단계에서 +5로 중간에 변경되는 문제
**해결**: 디플레이션이 턴 종료 시점에 적용되도록 변경

#### 기술적 세부사항:
- **이전 동작**: 에테르를 획득할 때 즉시 `comboUsageCount` 증가
  - 선택 단계: 카운트 0 → +10 미리보기
  - 진행 단계: 카운트 0 → +10 획득 → **카운트 1로 증가**
  - 다음 선택 단계: 카운트 1 → +5 미리보기 (혼란 발생)

- **수정된 동작**: 턴 종료 시 `comboUsageCount` 증가
  - 선택 단계: 카운트 0 → +10 미리보기
  - 진행 단계: 카운트 0 → +10 획득
  - **턴 종료**: 카운트 0 → 1로 증가
  - 다음 턴 선택 단계: 카운트 1 → +5 미리보기 ✅

#### 코드 변경:
1. `currentTurnCombo` state 추가: 이번 턴에 사용한 조합 추적
2. `applyEtherDeflation()` 함수 반환값 변경: 객체로 변경 (`{ gain, multiplier, usageCount }`)
3. `startResolve()`: 에테르 획득 시 카운트 증가하지 않음, `currentTurnCombo`에 조합명 저장
4. `finishTurn()`: 턴 종료 시 `currentTurnCombo`를 사용해 `comboUsageCount` 증가

### 2. 에테르 획득 배수 표시 추가 ✨
**기능**: 에테르 획득량 옆에 디플레이션 배수 표시

#### 표시 위치:
1. **미리보기 (선택 단계)**
   - 예: `+10 PT (×0.50)`
   - 1보다 작을 때만 표시
   - 색상: 붉은색 (`#ef4444`)

2. **로그 (진행 단계)**
   - 예: `✴️ 에테르 +5 pt ×0.50 (플레이어 족보: One Pair)`
   - HTML 색상 태그 사용

#### 향후 확장:
- 나중에 증가 요소 추가 시 파란색으로 표시 가능
- 배수가 1보다 클 때: `×1.50` (파란색)
- 배수가 1보다 작을 때: `×0.50` (붉은색)

### 3. 리드로우 단축키 추가 🎮
**기능**: R키로 리드로우 버튼 클릭

#### 구현:
- `useEffect` 키보드 핸들러에 R키 추가
- 선택 단계에서만 작동
- `canRedraw` 상태를 dependency에 추가
- 버튼 텍스트: `리드로우` → `리드로우 (R)`

### 4. 기원 버튼 UI 개선
**변경**: `text-sm` → `flex items-center gap-2` (일관성 개선)
**확인**: 기원 버튼은 이미 리드로우 버튼 밑에 올바르게 배치되어 있음

---

## 전체 단축키 목록
| 키 | 기능 | 조건 |
|---|---|---|
| **C** | 캐릭터 창 열기/닫기 | 항상 |
| **Q** | 카드 설명 간소화 ON/OFF | 선택 단계 |
| **E** | 제출 | 선택 단계 + 카드 선택됨 |
| **R** | 리드로우 | 선택 단계 + 리드로우 가능 |
| **A** | 한 단계 실행 | 진행 단계 |
| **D** | 전부 실행 | 진행 단계 |

---

## 디플레이션 시스템 정리

### 작동 방식
1. **턴 중**: 현재 `comboUsageCount`를 사용해 에테르 획득량 계산
2. **턴 종료**: 사용한 조합의 카운트 +1
3. **다음 턴**: 증가된 카운트로 미리보기 및 획득량 계산

### 공식
```javascript
배수 = (0.5) ^ 카운트
획득량 = Math.floor(기본값 × 배수)
```

### 예시: "One Pair" (기본값 10)
| 사용 횟수 | 카운트 | 배수 | 획득량 |
|---------|-------|------|-------|
| 1번째   | 0     | 1.00 | 10    |
| 2번째   | 1     | 0.50 | 5     |
| 3번째   | 2     | 0.25 | 2     |
| 4번째   | 3     | 0.13 | 1     |
| 5번째   | 4     | 0.06 | 0     |

---

## 파일 변경사항

### src/components/battle/LegacyBattleApp.jsx
- `applyEtherDeflation()`: 반환값 객체로 변경 (210-218줄)
- `currentTurnCombo` state 추가 (676줄)
- `pendingComboEther`: 객체 구조로 변경 (861-865줄)
- 키보드 단축키: R키 추가 (765-800줄)
- `startResolve()`: 에테르 획득 시 카운트 증가하지 않음 (978-990줄)
- `finishTurn()`: 턴 종료 시 카운트 증가 (1035-1050줄)
- 미리보기: 배수 표시 추가 (1220-1234줄)
- 리드로우 버튼: (R) 텍스트 추가 (1287-1289줄)
- 기원 버튼: 클래스 일관성 개선 (1290-1295줄)

### src/components/map/MapDemo.jsx
- 버전 태그: `11-18-11:42` → `11-18-12:06` (108줄)

---

## 버그 수정
✅ 디플레이션 타이밍 문제 해결 (턴 중간에 배수가 변경되던 문제)
✅ 에테르 획득 시 배수 표시로 투명성 개선

## 신규 기능
✨ R키로 리드로우 단축키
✨ 에테르 획득 배수 시각적 표시 (붉은색)

---

**패치 시간**: 2025-11-18 12:06 (KST)
**이전 버전**: v11-18-11:42
