# HANDOVER

## 현재 겪고 있는 문제
- **대응 단계에서 카드 순서 재배치 후 진행 단계에서 순서가 원복/섞임**: 유물/속도 기반 자동 정렬이 개입해, 수동으로 바꾼 순서를 진행 단계 UI/실행에서 유지하지 못함.
- **표시와 실행 순서 불일치**: 타임라인/예상 피해 등 표시 영역이 큐와 다른 순서 소스를 참조해 화면에 보이는 순서와 실제 실행이 어긋남.
- **성장/기억 시스템(초안)**:
  - 노드 이동 시 기억 +10 자동 획득, 기억 100 이상 + 휴식(rest) 노드에서 각성 가능.
  - 각성 선택지: 전사(용맹=힘+1, 굳건=최대체력+10), 현자(냉철=통찰+1, 철저=보조특기 슬롯+1), 영웅(열정=플레이어 최대 속도+5, 활력=행동력+1), 신앙=랜덤.
  - 각성 시 기억 100 소모. 특수카드/트라우마/추억 미구현.
  - DevTools 프리셋에 기억 추가, 각성 강제 버튼(기억 100 필요) 있음.
- **미해결**:
  - 활력(행동력+1) 전투 시작 에너지 반영이 불안정. “증가했다가 6으로 돌아감” 보고됨.
  - 타임라인은 공통 스케일을 쓰되 짧은 쪽만 짧게 표현하도록 수정했으나 재확인 필요.

## 지금까지 시도했으나 실패한 방법
1. sortCombinedOrderStablePF 정렬 제거 후 sp를 단순 증가로 처리 → 타임라인/진행 UI가 깨지고 배율 표시도 이상해짐.
2. 진행 진입 시 수동 순서(manualOrder/ixedOrder)를 큐에 그대로 복제 → 이후 자동 정렬/표시 로직이 다시 덮어씀.
3. 대응 단계 자동 정렬 useEffect를 잠금으로 막는 시도 → 다른 경로(자동 복구, 재정렬)에서 여전히 덮어씀.
4. 타임라인/예상 피해가 sp 기반 재정렬을 암묵적으로 수행 → 배열 순서를 반영하지 못함.
- 활력 반영 시도:
  - 전투 payload에서 기본 6 + 활력 보너스 + 유물 패시브 + 전투 시작 보너스 합산하도록 수정.
  - LegacyBattleApp에서 initialPlayer.energy가 없을 때 기본 6+보너스 계산. 그래도 실사용에서 감소 현상 발생.
  - 원인 추정: 전투 초기화 useEffect 등에서 energy가 기본값으로 덮어쓰이는 경로, energyBonus를 별도 필드로 넘기지 않아 누락되는 경로.

## 원인으로 추정되는 지점
- **다중 소스 사용**: 큐, 타임라인, 예상 피해, 자동 복구가 서로 다른 배열(fixedOrder, playerTimeline, queue)을 사용해 순서가 일관되지 않음.
- **자동 정렬 개입**: 대응 단계 useEffect, 자동 복구, 진행 진입 시 정렬 함수(sortCombinedOrderStablePF)가 다시 실행되어 수동 순서를 덮어씀.
- **sp 기반 재정렬/그룹핑**: 표시/예상 피해 계산 과정에서 sp 값으로 정렬하거나 묶으면서 수동 순서가 무시됨.
- **초기화 타이밍 혼선**: 잠금/수동 순서 초기화가 단계 전환마다 일어나 수동 순서가 풀려버림.
- **활력 불안정**:
  - payload에 energy만 넣고 energyBonus를 별도로 넘기지 않아, 이후 초기화에서 기본값으로 덮일 가능성.
  - LegacyBattleApp 초기화/phase 전환 시 energy/maxEnergy를 다시 세팅하는 경로가 있는지 확인 필요.

## 상세 해결 제안
1. **단일 소스 강제**
   - 순서 참조 우선순위: manualOrder > ixedOrder. 진행 큐/타임라인/예상 피해/자동 복구 모두 동일 소스 사용.
   - 진행 진입 시 manualOrder가 있으면 그것을 그대로 사용해 큐 생성. 없으면 기존 fixedOrder.

2. **자동 정렬 차단**
   - 대응 단계에서 manualOrderLocked가 true일 때는 어떤 setFixedOrder/sortCombinedOrderStablePF도 호출하지 않도록 guard.
   - 자동 복구/새 적 전환 등에서도 잠금 시 재정렬 호출 금지.

3. **정렬 제거, sp 재계산만**
   - sortCombinedOrderStablePF: 입력 순서 유지, sp/finalSpeed만 계산(정렬 로직 삭제).
   - 진행 진입 시 sp/idx는 앞에서부터 단순 누적 계산(정렬 호출 없음). sp는 표시용 값으로만 사용.
   - 표시/예상 피해/미리보기 등에서 sp를 기준으로 정렬/그룹핑하는 코드가 있으면 제거하고 전달된 배열 순서를 그대로 사용.

4. **초기화 시점 명확화**
   - 선택 단계/새 전투 시작 시점에서만 manualOrder와 잠금을 초기화.
   - 대응→진행 전환 시에는 잠금 해제하지 않고 수동 순서를 유지.

5. **검증 플로우**
   - 대응 단계에서 순서를 바꾸고 진행 단계로 넘어가 UI/실행/예상 피해 모두 동일 순서인지 수동 테스트.
   - 
pm run build로 기본 빌드 확인 후 실제 게임 플레이로 검증.

## 현재 상태
- 브랜치: claude/check-responsiveness-01WbgS136iR7Qv8ZmsANG367 (origin 대비 behind 10, 로컬 ahead 1)
- 주요 수정 파일: src/components/battle/LegacyBattleApp.jsx, LegacyBattleScreen.jsx, CharacterSheet.jsx, MapDemo.jsx, gameStore.js, useGameState.js
- 워크트리: 수정 반영 중(충돌 없음). 활력/각성 관련 추가 작업 필요.

## 2025-XX-XX 추가 메모 (상태 표시/몬스터 카드)
- 플레이어 상태(힘/민첩/통찰/우둔/범람)를 체력바 바로 아래 한 줄로만 표시하도록 추가했음. HP 블록 옆에 중복 상태 라인 요구가 반복됐으니, 아래 라인만 남기는 형태 유지 필요.
- 적 카드 미사용 이슈: 적 덱이 비거나 없을 때 기본 ENEMY_CARDS에서 카드 풀을 가져와 항상 행동이 생성되도록 `generateEnemyActions`에서 대체 처리.
- 몬스터 다수일 때 이름/이모지 중복: 동일 이름을 묶어 `xN` 표기. 이름만 기준이라 이모지가 다르면 같은 이름으로 묶이는 점 유의.
- 코드가 매우 커서 HP 바 주변(약 3700행대) 수정 시 `apply_patch`가 자주 실패. 필요 시 해당 구간만 부분 편집 권장.

## 다음 담당자용 체크리스트
- 활력(행동력+1) 전투 반영 재확인:
  - payload에 energyBonus를 명시적으로 포함하거나, LegacyBattleApp에서 기본 6 + energyBonus + 패시브를 한 번 더 강제 적용하는 등 덮어쓰기 경로 제거.
  - LegacyBattleApp 초기화(useEffect)에서 energy/maxEnergy가 기본값으로 재설정되는지 로그/브레이크포인트로 추적.
- 성장/기억:
  - 트라우마/추억, 특수카드 지급 미구현. 휴식당 각성 1회 제한 등 룰 명확화 필요.
- 카드 순서 문제:
  - 단일 소스/자동 정렬 차단/표시 정렬 제거 등 위 제안대로 일관성 확보 필요.
