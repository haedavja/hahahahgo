# HANDOVER

## 현재 겪고 있는 문제
- **대응 단계에서 카드 순서 재배치 후 진행 단계에서 순서가 원복/섞임**: 유물/속도 기반 자동 정렬이 개입해, 수동으로 바꾼 순서를 진행 단계 UI/실행에서 유지하지 못함.
- **표시와 실행 순서 불일치**: 타임라인/예상 피해 등 표시 영역이 큐와 다른 순서 소스를 참조해 화면에 보이는 순서와 실제 실행이 어긋남.

## 지금까지 시도했으나 실패한 방법
1. sortCombinedOrderStablePF 정렬 제거 후 sp를 단순 증가로 처리 → 타임라인/진행 UI가 깨지고 배율 표시도 이상해짐.
2. 진행 진입 시 수동 순서(manualOrder/ixedOrder)를 큐에 그대로 복제 → 이후 자동 정렬/표시 로직이 다시 덮어씀.
3. 대응 단계 자동 정렬 useEffect를 잠금으로 막는 시도 → 다른 경로(자동 복구, 재정렬)에서 여전히 덮어씀.
4. 타임라인/예상 피해가 sp 기반 재정렬을 암묵적으로 수행 → 배열 순서를 반영하지 못함.

## 원인으로 추정되는 지점
- **다중 소스 사용**: 큐, 타임라인, 예상 피해, 자동 복구가 서로 다른 배열(fixedOrder, playerTimeline, queue)을 사용해 순서가 일관되지 않음.
- **자동 정렬 개입**: 대응 단계 useEffect, 자동 복구, 진행 진입 시 정렬 함수(sortCombinedOrderStablePF)가 다시 실행되어 수동 순서를 덮어씀.
- **sp 기반 재정렬/그룹핑**: 표시/예상 피해 계산 과정에서 sp 값으로 정렬하거나 묶으면서 수동 순서가 무시됨.
- **초기화 타이밍 혼선**: 잠금/수동 순서 초기화가 단계 전환마다 일어나 수동 순서가 풀려버림.

## 상세 해결 제안
1. **단일 소스 강제**
   - 순서 참조 우선순위: manualOrder > ixedOrder. 진행 큐/타임라인/예상 피해/자동 복구 모두 동일 소스 사용.
   - 진행 진입 시 manualOrder가 있으면 그것을 그대로 사용해 큐 생성. 없으면 기존 fixedOrder.

2. **자동 정렬 차단**
   - 대응 단계에서 manualOrderLocked가 true일 때는 어떤 setFixedOrder/sortCombinedOrderStablePF도 호출하지 않도록 guard.
   - 자동 복구/새 적 전환 등에서도 잠금 시 재정렬 호출 금지.

3. **정렬 제거, sp 재계산만**
   - sortCombinedOrderStablePF: 입력 순서 유지, sp/finalSpeed만 계산(정렬 로직 삭제).
   - 진행 진입 시 sp/idx는 앞에서부터 단순 누적 계산(정렬 호출 없음). sp는 표시용 값으로만 사용.
   - 표시/예상 피해/미리보기 등에서 sp를 기준으로 정렬/그룹핑하는 코드가 있으면 제거하고 전달된 배열 순서를 그대로 사용.

4. **초기화 시점 명확화**
   - 선택 단계/새 전투 시작 시점에서만 manualOrder와 잠금을 초기화.
   - 대응→진행 전환 시에는 잠금 해제하지 않고 수동 순서를 유지.

5. **검증 플로우**
   - 대응 단계에서 순서를 바꾸고 진행 단계로 넘어가 UI/실행/예상 피해 모두 동일 순서인지 수동 테스트.
   - 
pm run build로 기본 빌드 확인 후 실제 게임 플레이로 검증.

## 현재 상태
- 브랜치: claude/check-responsiveness-01WbgS136iR7Qv8ZmsANG367
- 파일: src/components/battle/LegacyBattleApp.jsx
- 워크트리: 롤백 후 다시 수정 시도 전 상태(깨끗하거나 변경 사항 없음).
- 이후 작업 시 위 제안에 따라 단계별로 정리하는 것이 필요.
